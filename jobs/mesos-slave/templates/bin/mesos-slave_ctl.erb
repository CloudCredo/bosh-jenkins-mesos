#!/bin/bash

set -e 
set -u 

function setup_java_environment() {
  export PATH=$JAVA_HOME/bin:$PATH
  export JAVA_HOME=/var/vcap/packages/openjdk/jdk/
}

function setup_mesos_environment() {
  export MESOS_HOME=/var/vcap/packages/mesos/
  #export LIBPROCESS_IP=<%= spec.networks.send(p('mesos.network')).ip %>
  chown --recursive vcap:vcap $MESOS_HOME
}

function setup_bosh_environment() {
  JOB_NAME=mesos-slave
  LOG_DIR=/var/vcap/sys/log/$JOB_NAME
  RUN_DIR=/var/vcap/sys/run/$JOB_NAME
  PIDFILE=$RUN_DIR/$JOB_NAME.pid
  chown --recursive vcap:vcap $LOG_DIR
  mkdir -p $LOG_DIR
  mkdir -p $RUN_DIR
}

function start_mesos() {
  flags=(
    --log_dir=$LOG_DIR 
    #--port=<%= p("mesos.slave.port") %>
    --checkpoint=true  
    #--master=zk://<%= p("mesos.zookeeper.ip") %>:<%= p("mesos.zookeeper.port") %>/mesos 
    --no-switch_user 
    --hostname=$LIBPROCESS_IP 
  )  

  exec chpst -u vcap:vcap $MESOS_HOME/bin/mesos-slave.sh ${flags[*]} \
    1>>$LOG_DIR/$JOB_NAME.stdout.log \
    2>>$LOG_DIR/$JOB_NAME.stderr.log &
    
  echo $! > $PIDFILE
}

function kill_mesos() {
  kill `cat $PIDFILE`
}

case $1 in
  start)
    setup_bosh_environment    
    setup_java_environment     
    setup_mesos_environment
    start_mesos
    ;;

  stop)
    kill_mesos 
    ;;
  *)
    echo "Usage: $0 : {start|stop}"
    ;;

esac
exit 0
